<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Gesti√≥n de Pagos por DNI</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  <style>
    :root {
      --maiz: #FD9800;
      --maiz-secundario: #E98C00;
      --azul-oscuro: #0F172A;
      --gris-oscuro: #454F5E;
      --beige: #FEF9E1;
      --beige-suave: #F9F0C8;
      --blanco: #FFFFFF;
    }

    body {
      font-family: 'Segoe UI', sans-serif;
      background-color: var(--beige-suave);
      color: var(--azul-oscuro);
      padding: 30px;
      text-align: center;
    }

    h2 {
      color: var(--maiz);
    }

    input, select {
      padding: 12px;
      width: 280px;
      font-size: 16px;
      border: 2px solid var(--maiz);
      border-radius: 6px;
      margin: 5px 0;
      background-color: var(--blanco);
    }

    button {
      padding: 10px 16px;
      font-size: 15px;
      background-color: var(--maiz);
      color: var(--azul-oscuro);
      border: none;
      border-radius: 6px;
      cursor: pointer;
      margin-top: 8px;
    }

    button:hover {
      background-color: var(--maiz-secundario);
    }

    .btn-categoria {
      width: 140px;
      height: 80px;
      font-size: 18px;
      font-weight: bold;
      background-color: var(--maiz);
      color: var(--azul-oscuro);
      border: none;
      border-radius: 12px;
      margin: 10px;
      cursor: pointer;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.15);
    }

    .grid-tarjetas {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
      justify-items: center;
    }

    .tarjeta {
      background-color: var(--beige);
      border-left: 6px solid var(--maiz);
      padding: 15px;
      border-radius: 10px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      text-align: left;
      width: 100%;
      max-width: 500px;
    }

    .estado {
      font-weight: bold;
    }

    .estado-pendiente { color: red; }
    .estado-enproceso { color: orange; }
    .estado-pagado { color: green; }

    .comprobante-link {
      font-size: 14px;
      margin-top: 4px;
      display: block;
    }

    .input-archivo {
      margin-top: 8px;
    }

    #mensajeCarga {
      font-size: 16px;
      font-weight: bold;
      color: var(--gris-oscuro);
      margin-top: 15px;
    }
  </style>
</head>
<body>
  <h2>Consulta de Pagos por DNI</h2>
  <input type="text" id="dniInput" placeholder="Ingrese su DNI">
  <button onclick="buscarPagos()">Buscar</button>
  <div id="mensajeCarga"></div>
  <div id="filtros" style="display:none; margin: 30px 0;">
    <button class="btn-categoria" onclick="filtrarCategoria('agua')">Agua</button>
    <button class="btn-categoria" onclick="filtrarCategoria('luz')">Luz</button>
    <button class="btn-categoria" onclick="filtrarCategoria('alquiler')">Alquiler</button>
    <button class="btn-categoria" onclick="filtrarCategoria('vigilancia')">Vigilancia</button>
    <button class="btn-categoria" onclick="filtrarCategoria('')">Todos</button>
  </div>
  <h3 id="totalPagos"></h3>
  <div class="grid-tarjetas" id="resultados"></div>

  <script>
    const endpoint = "https://script.google.com/macros/s/AKfycbybsBKmk4XR2XwUyS3ytoW64yFclmJAhE1s9i5ejj5rukbzKvFTizAEQwvBKNTxNNo5/exec";
    let datos = [];

    function buscarPagos() {
      const dni = document.getElementById("dniInput").value.trim();
      if (!dni) return alert("Ingrese un DNI v√°lido");

      document.getElementById("mensajeCarga").textContent = "üîÑ Buscando...";
      fetch(`${endpoint}?dni=${dni}`)
        .then(res => res.json())
        .then(data => {
          datos = data;
          document.getElementById("mensajeCarga").textContent = "";
          document.getElementById("filtros").style.display = data.length > 0 ? "block" : "none";
          renderResultados(data);
        })
        .catch(() => alert("Error al buscar datos"));
    }

    function renderResultados(data) {
      const contenedor = document.getElementById("resultados");
      contenedor.innerHTML = "";
      let total = 0;

      data.forEach((item, i) => {
        const estadoClass = item.Estado.toLowerCase() === "pagado" ? "estado-pagado" :
                            item.Estado.toLowerCase() === "en proceso" ? "estado-enproceso" : "estado-pendiente";

        if (!isNaN(parseFloat(item.Monto))) total += parseFloat(item.Monto);

        const tarjeta = document.createElement("div");
        tarjeta.className = `tarjeta tarjeta-${item.Servicio.toLowerCase()}`;
        tarjeta.innerHTML = `
          <div><strong>Servicio:</strong> ${item.Servicio}</div>
          <div><strong>Fecha:</strong> ${item.Fecha}</div>
          <div><strong>Monto:</strong> S/ ${item.Monto}</div>
          <div><strong>Estado:</strong> <span class="estado ${estadoClass}">${item.Estado}</span></div>
          ${item.Comprobante ? `<a class="comprobante-link" href="${item.Comprobante}" target="_blank">Ver comprobante</a>` : ""}
        `;

        if (item.Estado.toLowerCase() === "pendiente") {
          const form = document.createElement("form");
          form.innerHTML = `
            <input type="file" class="input-archivo" accept="image/*" required id="archivo-${i}">
            <button type="submit">Subir comprobante</button>
          `;
          form.addEventListener("submit", e => {
            e.preventDefault();
            subirComprobante(item.Dni, item.Fecha, item.Servicio, i);
          });
          tarjeta.appendChild(form);
        }

        const botonPDF = document.createElement("button");
        botonPDF.textContent = "Descargar boleta PDF";
        botonPDF.onclick = () => {
          html2pdf().from(tarjeta).save(`boleta_${item.Dni}_${item.Servicio}_${item.Fecha}.pdf`);
        };
        tarjeta.appendChild(botonPDF);

        contenedor.appendChild(tarjeta);
      });

      document.getElementById("totalPagos").textContent = `Total mostrado: S/ ${total.toFixed(2)}`;
    }

    function subirComprobante(dni, fecha, servicio, i) {
      const input = document.getElementById(`archivo-${i}`);
      const archivo = input.files[0];
      if (!archivo) return alert("Seleccione un archivo");

      document.getElementById("mensajeCarga").textContent = "üì§ Subiendo...";

      const reader = new FileReader();
      reader.onload = async () => {
        const formData = new URLSearchParams();
        formData.append("dni", dni);
        formData.append("fecha", fecha);
        formData.append("servicio", servicio);
        formData.append("archivo", reader.result);
        formData.append("nombre", archivo.name);

        try {
          await fetch(endpoint, { method: "POST", body: formData });
          buscarPagos();
        } catch {
          alert("Error al subir comprobante");
        } finally {
          document.getElementById("mensajeCarga").textContent = "";
        }
      };
      reader.readAsDataURL(archivo);
    }

    function filtrarCategoria(cat) {
      const tarjetas = document.querySelectorAll(".tarjeta");
      tarjetas.forEach(t => {
        t.style.display = !cat || t.classList.contains(`tarjeta-${cat}`) ? "block" : "none";
      });
    }
  </script>
</body>
</html>
