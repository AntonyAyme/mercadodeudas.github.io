<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Gestión de Deudas</title>
  <style>
    :root {
      --maiz: #FD9800;
      --maiz-secundario: #E98C00;
      --azul-oscuro: #0F172A;
      --gris-oscuro: #454F5E;
      --beige: #FEF9E1;
      --beige-suave: #F9F0C8;
      --blanco: #FFFFFF;
    }

    body {
      font-family: 'Segoe UI', sans-serif;
      background-color: var(--beige-suave);
      color: var(--azul-oscuro);
      padding: 30px;
      text-align: center;
    }

    h2 {
      color: var(--maiz);
    }

    input, select {
      padding: 12px;
      width: 280px;
      font-size: 16px;
      border: 2px solid var(--maiz);
      border-radius: 6px;
      margin: 5px 0;
      background-color: var(--blanco);
    }

    button {
      padding: 10px 16px;
      font-size: 15px;
      background-color: var(--maiz);
      color: var(--azul-oscuro);
      border: none;
      border-radius: 6px;
      cursor: pointer;
      margin-top: 8px;
    }

    button:hover {
      background-color: var(--maiz-secundario);
    }

    .btn-categoria {
      width: 140px;
      height: 80px;
      font-size: 18px;
      font-weight: bold;
      background-color: var(--maiz);
      color: var(--azul-oscuro);
      border: none;
      border-radius: 12px;
      margin: 10px;
      cursor: pointer;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.15);
    }

    .btn-categoria:hover {
      background-color: var(--maiz-secundario);
    }

    .tarjeta {
      background-color: var(--beige);
      border-left: 6px solid var(--maiz);
      padding: 15px;
      margin: 20px auto;
      border-radius: 10px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      text-align: left;
      max-width: 600px;
    }

    .estado {
      font-weight: bold;
    }

    .estado-pendiente { color: red; }
    .estado-enproceso { color: orange; }
    .estado-pagado { color: green; }

    .comprobante-link {
      font-size: 14px;
      margin-top: 4px;
      display: block;
    }

    .input-archivo {
      margin-top: 8px;
    }

    hr {
      border: none;
      height: 1px;
      background-color: var(--gris-oscuro);
      margin: 30px auto;
      max-width: 600px;
    }
  </style>
</head>
<body>

  <h2>Consulta de Deudas</h2>
  <input type="email" id="emailInput" placeholder="Ej. juan@example.com" required>
  <button onclick="buscarPagos()">Buscar</button>

  <div id="filtros" style="display:none; margin: 30px 0;">
    <button class="btn-categoria" onclick="filtrarCategoria('alquiler')">Alquiler</button>
    <button class="btn-categoria" onclick="filtrarCategoria('vigilancia')">Vigilancia</button>
    <button class="btn-categoria" onclick="filtrarCategoria('luz')">Luz</button>
    <button class="btn-categoria" onclick="filtrarCategoria('agua')">Agua</button>
    <button class="btn-categoria" onclick="filtrarCategoria('')">Todas</button>
  </div>

  <div id="resultados"></div>

  <script>
    const endpoint = "https://script.google.com/macros/s/AKfycbybsBKmk4XR2XwUyS3ytoW64yFclmJAhE1s9i5ejj5rukbzKvFTizAEQwvBKNTxNNo5/exec";
    let datos = [];
    let emailActual = "";

    function buscarPagos() {
      const email = document.getElementById('emailInput').value.trim();
      if (!email) {
        alert("Por favor, ingresa un correo válido.");
        return;
      }

      emailActual = email;

      fetch(`${endpoint}?email=${encodeURIComponent(email)}`)
        .then(res => res.json())
        .then(data => {
          datos = data;
          document.getElementById("filtros").style.display = data.length > 0 ? "block" : "none";
          renderResultados(data);
        })
        .catch(err => {
          console.error(err);
          alert("Error al consultar las deudas.");
        });
    }

    function renderResultados(data) {
      const contenedor = document.getElementById("resultados");
      contenedor.innerHTML = "";

      if (data.length === 0) {
        contenedor.innerHTML = "<p>No se encontraron deudas para este correo.</p>";
        return;
      }

      data.forEach((item, index) => {
        const estadoClass =
          item.estado.toLowerCase() === "pagado"
            ? "estado-pagado"
            : item.estado.toLowerCase() === "en proceso"
            ? "estado-enproceso"
            : "estado-pendiente";

        const tarjeta = document.createElement("div");
        tarjeta.className = "tarjeta tarjeta-categoria-" + item.categoría.toLowerCase();
        tarjeta.innerHTML = `
          <div><strong>Mes:</strong> ${item.mes}</div>
          <div><strong>Categoría:</strong> ${item.categoría}</div>
          <div><strong>Monto:</strong> S/ ${item.monto}</div>
          <div><strong>Estado:</strong> <span class="estado ${estadoClass}">${item.estado}</span></div>
          ${item.comprobante ? `<a class="comprobante-link" href="${item.comprobante}" target="_blank">Ver comprobante</a>` : ""}
        `;

        // Subir comprobante solo si está pendiente
        if (item.estado.toLowerCase() === "pendiente") {
          const form = document.createElement("form");
          form.innerHTML = `
            <input type="file" class="input-archivo" accept="image/*" required id="archivo-${index}">
            <button type="submit">Subir comprobante</button>
          `;
          form.addEventListener("submit", e => {
            e.preventDefault();
            subirComprobante(emailActual, item.mes, item.categoría, index);
          });
          tarjeta.appendChild(form);
        }

        contenedor.appendChild(tarjeta);
        const separador = document.createElement("hr");
        contenedor.appendChild(separador);
      });
    }

    function subirComprobante(email, mes, categoria, index) {
      const inputArchivo = document.getElementById(`archivo-${index}`);
      const archivo = inputArchivo.files[0];

      if (!archivo) {
        alert("Selecciona un archivo.");
        return;
      }

      const reader = new FileReader();
      reader.onload = async function () {
        const base64 = reader.result;

        const formData = new URLSearchParams();
        formData.append("email", email);
        formData.append("mes", mes);
        formData.append("categoria", categoria);
        formData.append("archivo", base64);
        formData.append("nombre", archivo.name);

        try {
          const res = await fetch(endpoint, {
            method: "POST",
            body: formData
          });
          const texto = await res.text();
          alert(texto);
          buscarPagos(); // Refrescar
        } catch (err) {
          console.error(err);
          alert("Error al subir comprobante.");
        }
      };

      reader.readAsDataURL(archivo);
    }

    function filtrarCategoria(categoria) {
      const tarjetas = document.querySelectorAll(".tarjeta");
      tarjetas.forEach(t => {
        const visible = !categoria || t.classList.contains(`tarjeta-categoria-${categoria.toLowerCase()}`);
        t.style.display = visible ? "block" : "none";
      });
    }
  </script>
</body>
</html>
